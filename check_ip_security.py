#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ IP –∞–¥—Ä–µ—Å–æ–≤
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from app.database import get_db
from app.models import AllowedIP
from sqlalchemy.orm import Session

def check_ip_security():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ IP –∞–¥—Ä–µ—Å–æ–≤"""
    print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ IP –∞–¥—Ä–µ—Å–æ–≤...")
    print("=" * 50)
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Å—Å–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    db = next(get_db())
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö IP
        allowed_ips = db.query(AllowedIP).filter(AllowedIP.is_active == True).all()
        
        print(f"üìä –ù–∞–π–¥–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö IP –∞–¥—Ä–µ—Å–æ–≤: {len(allowed_ips)}")
        
        if not allowed_ips:
            print("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö IP –∞–¥—Ä–µ—Å–æ–≤!")
            print("   –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ IP –æ—Ç–∫–ª—é—á–µ–Ω–∞ –∏ –ª—é–±–æ–π –º–æ–∂–µ—Ç –æ—Ç–º–µ—á–∞—Ç—å—Å—è.")
            print("   –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ IP –∞–¥—Ä–µ—Å–∞.")
        else:
            print("\nüìã –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö IP –∞–¥—Ä–µ—Å–æ–≤:")
            for ip in allowed_ips:
                status = "‚úÖ –ê–∫—Ç–∏–≤–µ–Ω" if ip.is_active else "‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω"
                print(f"   ‚Ä¢ {ip.ip_address} - {ip.description or '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'} ({status})")
        
        print("\nüîß –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ IP:")
        print("   1. –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
        print("   2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª '–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ IP'")
        print("   3. –î–æ–±–∞–≤—å—Ç–µ IP –∞–¥—Ä–µ—Å–∞ –≤–∞—à–µ–π —Å–µ—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 192.168.1.1)")
        print("   4. –°–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–µ—Ä–≤—ã–µ 3 –æ–∫—Ç–µ—Ç–∞ (192.168.1.x)")
        
        print("\nüåê –ü—Ä–∏–º–µ—Ä—ã IP –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:")
        print("   ‚Ä¢ 192.168.1.1 - –¥–ª—è —Å–µ—Ç–∏ 192.168.1.x")
        print("   ‚Ä¢ 10.0.0.1 - –¥–ª—è —Å–µ—Ç–∏ 10.0.0.x")
        print("   ‚Ä¢ 172.16.0.1 - –¥–ª—è —Å–µ—Ç–∏ 172.16.0.x")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ: {e}")
    finally:
        db.close()

if __name__ == "__main__":
    check_ip_security()
